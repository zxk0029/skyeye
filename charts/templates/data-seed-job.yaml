{{- if .Values.dataSeed.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "app.fullname" . }}-data-seed
  labels:
    {{- include "app.labels" . | nindent 4 }}
    app.kubernetes.io/component: data-seed
  annotations:
    # ç¡®ä¿æ¯æ¬¡éƒ¨ç½²éƒ½é‡æ–°æ‰§è¡Œ
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      name: {{ include "app.fullname" . }}-data-seed
      labels:
        {{- include "app.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: data-seed
    spec:
      restartPolicy: Never
      containers:
      - name: data-seed
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        env:
        {{- range $key, $value := .Values.env }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}
        {{- if .Values.dataSeed.configMapName }}
        - name: SEED_DATA_FILE
          value: "/seed-data/{{ .Values.dataSeed.fileName }}"
        {{- end }}
        command: ["/bin/sh"]
        args:
        - -c
        - |
          echo "ğŸ” æ•°æ®ç§å­å¯¼å…¥ä»»åŠ¡å¯åŠ¨"
          
          # ç­‰å¾…æ•°æ®åº“å°±ç»ª
          echo "â³ ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
          timeout 300 bash -c 'until pg_isready -h $POSTGRES_HOST_MASTER -p $POSTGRES_PORT_MASTER -U $POSTGRES_USER; do sleep 2; done'
          
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®
          ASSET_COUNT=$(python manage.py shell -c "from apps.cmc_proxy.models import CmcAsset; print(CmcAsset.objects.count())" | tail -1)
          echo "å½“å‰èµ„äº§æ•°é‡: $ASSET_COUNT"
          
          if [ "$ASSET_COUNT" -lt {{ .Values.dataSeed.minAssetCount | default 1000 }} ]; then
            if [ -n "$SEED_DATA_FILE" ] && [ -f "$SEED_DATA_FILE" ]; then
              echo "ğŸ“¥ å¯¼å…¥ç§å­æ•°æ®æ–‡ä»¶: $SEED_DATA_FILE"
              psql -h $POSTGRES_HOST_MASTER -p $POSTGRES_PORT_MASTER -U $POSTGRES_USER -d $POSTGRES_DB < "$SEED_DATA_FILE"
              echo "âœ… ç§å­æ•°æ®å¯¼å…¥å®Œæˆ"
            else
              echo "âš ï¸ æœªæ‰¾åˆ°ç§å­æ•°æ®æ–‡ä»¶ï¼Œè·³è¿‡å¯¼å…¥"
              echo "ğŸ’¡ å»ºè®®: å…ˆåœ¨æœ¬åœ°è¿è¡Œ ./scripts/prepare_production_data.sh å‡†å¤‡ç§å­æ•°æ®"
            fi
          else
            echo "âœ… æ•°æ®å……è¶³ï¼Œè·³è¿‡ç§å­æ•°æ®å¯¼å…¥"
          fi
          
          # éªŒè¯æ•°æ®
          echo "ğŸ“Š éªŒè¯å¯¼å…¥ç»“æœ..."
          python manage.py shell -c "
          from apps.cmc_proxy.models import CmcAsset, CmcMarketData, CmcKline
          print(f'âœ… CmcAsset: {CmcAsset.objects.count():,} æ¡')
          print(f'âœ… CmcMarketData: {CmcMarketData.objects.count():,} æ¡')
          print(f'âœ… CmcKline: {CmcKline.objects.count():,} æ¡')
          "
          
          echo "ğŸ‰ æ•°æ®ç§å­ä»»åŠ¡å®Œæˆ"
        {{- if .Values.dataSeed.configMapName }}
        volumeMounts:
        - name: seed-data
          mountPath: /seed-data
          readOnly: true
        {{- end }}
      {{- if .Values.dataSeed.configMapName }}
      volumes:
      - name: seed-data
        configMap:
          name: {{ .Values.dataSeed.configMapName }}
      {{- end }}
  backoffLimit: 3
{{- end }}